name: Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**/*.md'
      - '**/*.MD'
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute Version
        id: get-version
        shell: pwsh
        run: |
          $version = "1.0.$env:GITHUB_RUN_NUMBER"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Determine Release Mode
        id: release-mode
        shell: pwsh
        run: |
          $runtimeReady = Test-Path "desktop/build.gradle.kts"
          "runtime_ready=$($runtimeReady.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          if ($runtimeReady) {
            Write-Host "Runtime modules detected. Running full packaging flow."
          } else {
            Write-Host "Runtime modules not detected. Running launcher-only scaffold checks."
          }

      - name: Build Launcher (Scaffold Mode)
        if: steps.release-mode.outputs.runtime_ready != 'true'
        run: ./gradlew :launcher:build

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk --version 0.0.1298

      - name: Download Previous Velopack Packages
        shell: pwsh
        env:
          GH_API_TOKEN: ${{ secrets.VELOPACK_TOKEN || secrets.velopack_token || github.token }}
        run: |
          New-Item -ItemType Directory -Force -Path "releases/windows" | Out-Null
          if (-not $env:GH_API_TOKEN) {
            Write-Host "No token available for release prefetch; continuing without cache."
            exit 0
          }
          $headers = @{
            Authorization = "Bearer $env:GH_API_TOKEN"
            Accept = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
            "User-Agent" = "gok-release-prefetch"
          }
          $assetHeaders = @{
            Authorization = "Bearer $env:GH_API_TOKEN"
            Accept = "application/octet-stream"
            "X-GitHub-Api-Version" = "2022-11-28"
            "User-Agent" = "gok-release-prefetch"
          }
          $releasesUrl = "https://api.github.com/repos/${{ github.repository }}/releases?per_page=12"
          try {
            $releases = Invoke-RestMethod -Headers $headers -Uri $releasesUrl -Method Get
          } catch {
            Write-Host "No previous release metadata available; continuing without cache."
            exit 0
          }
          if (-not $releases -or $releases.Count -eq 0) {
            Write-Host "No previous release found; continuing without cache."
            exit 0
          }
          $assets = @()
          $latestTag = $releases[0].tag_name
          foreach ($release in $releases) {
            foreach ($asset in $release.assets) {
              # Keep all recent deltas so clients can patch across skipped versions.
              if ($asset.name -like "*-delta.nupkg") {
                $assets += $asset
                continue
              }
              # Keep only latest full package as fallback and as delta base for next build.
              if ($release.tag_name -eq $latestTag -and $asset.name -like "*-full.nupkg") {
                $assets += $asset
              }
            }
          }
          $assets = $assets | Sort-Object name -Unique
          if (-not $assets -or $assets.Count -eq 0) {
            Write-Host "No Velopack assets found in previous release; continuing without cache."
            exit 0
          }
          $downloaded = 0
          foreach ($asset in $assets) {
            $destination = Join-Path "releases/windows" $asset.name
            Write-Host "Downloading previous asset: $($asset.name)"
            $ok = $false
            try {
              Invoke-WebRequest -Headers $assetHeaders -Uri $asset.url -OutFile $destination
              $ok = $true
            } catch {
              Write-Host "Asset API download failed for $($asset.name); trying browser URL."
            }
            if (-not $ok) {
              try {
                Invoke-WebRequest -Headers $assetHeaders -Uri $asset.browser_download_url -OutFile $destination
                $ok = $true
              } catch {
                Write-Host "Skipping previous asset $($asset.name): $($_.Exception.Message)"
              }
            }
            if ($ok) {
              $downloaded++
            } elseif (Test-Path $destination) {
              Remove-Item -Force $destination
            }
          }
          if ($downloaded -eq 0) {
            Write-Host "No previous Velopack assets downloaded; continuing without cache."
          }

      - name: Build and Pack
        shell: pwsh
        env:
          VELOPACK_TOKEN: ${{ secrets.VELOPACK_TOKEN || secrets.velopack_token }}
        run: |
          $args = @("-Version", "${{ steps.get-version.outputs.version }}")
          if ("${{ steps.release-mode.outputs.runtime_ready }}" -ne "true") {
            $args += "-LauncherOnly"
          }
          powershell -ExecutionPolicy Bypass -File scripts/pack.ps1 @args

      - name: Verify Release Artifacts
        shell: pwsh
        run: |
          $releases = "releases/windows/RELEASES"
          $setup = Get-ChildItem "releases/windows" -Filter "*Setup*.exe" -ErrorAction SilentlyContinue
          if (-not $setup -or $setup.Count -eq 0) { throw "Missing setup exe in releases/windows (expected *Setup*.exe)" }
          if (-not (Test-Path $releases)) { throw "Missing $releases" }
          $nupkg = Get-ChildItem "releases/windows" -Filter "*.nupkg" -ErrorAction SilentlyContinue
          if (-not $nupkg -or $nupkg.Count -eq 0) { throw "Missing .nupkg in releases/windows" }

      - name: Render Release Body
        id: render-body
        shell: pwsh
        run: powershell -ExecutionPolicy Bypass -File scripts/render-release-body.ps1 -Version ${{ steps.get-version.outputs.version }}

      - name: Upload Release (Velopack)
        shell: pwsh
        env:
          VELOPACK_TOKEN: ${{ secrets.VELOPACK_TOKEN || secrets.velopack_token || github.token }}
        run: |
          if (-not $env:VELOPACK_TOKEN) { throw "Missing VELOPACK_TOKEN secret (expected secrets.VELOPACK_TOKEN or secrets.velopack_token)"; }
          $maxAttempts = 5
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            Write-Host "Uploading release (attempt $attempt of $maxAttempts)..."
            vpk upload github --repoUrl https://github.com/${{ github.repository }} --token $env:VELOPACK_TOKEN --channel win --publish --releaseName "Gardens of Karaxas ${{ steps.get-version.outputs.version }}" --tag v${{ steps.get-version.outputs.version }} --outputDir "releases/windows"
            if ($LASTEXITCODE -eq 0) { break }
            if ($attempt -eq $maxAttempts) { throw "vpk upload failed after $maxAttempts attempts." }
            $delay = [Math]::Min(120, 5 * [Math]::Pow(2, $attempt - 1))
            Write-Host "Upload failed. Retrying in $delay seconds..."
            Start-Sleep -Seconds $delay
          }

      - name: Notify Backend Release Activation
        shell: pwsh
        env:
          KARAXAS_BACKEND_OPS_URL: ${{ secrets.KARAXAS_BACKEND_OPS_URL || vars.KARAXAS_BACKEND_OPS_URL }}
          KARAXAS_OPS_TOKEN: ${{ secrets.KARAXAS_OPS_TOKEN }}
        run: |
          if (-not $env:KARAXAS_BACKEND_OPS_URL) {
            Write-Host "KARAXAS_BACKEND_OPS_URL not configured. Skipping backend notification."
            exit 0
          }
          if (-not $env:KARAXAS_OPS_TOKEN) {
            Write-Host "KARAXAS_OPS_TOKEN not configured. Skipping backend notification."
            exit 0
          }

          $url = "$($env:KARAXAS_BACKEND_OPS_URL.TrimEnd('/'))/ops/release/activate"
          $payload = @{
            latest_version = "${{ steps.get-version.outputs.version }}"
            min_supported_version = "${{ steps.get-version.outputs.version }}"
            grace_minutes = 5
          } | ConvertTo-Json

          $maxAttempts = 3
          $notified = $false
          for ($attempt = 1; $attempt -le $maxAttempts; $attempt++) {
            try {
              Invoke-RestMethod `
                -Uri $url `
                -Method Post `
                -Headers @{ "x-ops-token" = $env:KARAXAS_OPS_TOKEN } `
                -ContentType "application/json" `
                -Body $payload | Out-Null
              Write-Host "Backend release activation notified."
              $notified = $true
              break
            } catch {
              $message = $_.Exception.Message
              if ($attempt -lt $maxAttempts) {
                $delay = 10 * $attempt
                Write-Host "Backend notification failed (attempt $attempt/$maxAttempts): $message. Retrying in $delay seconds..."
                Start-Sleep -Seconds $delay
              } else {
                Write-Warning "Backend notification failed after $maxAttempts attempts: $message. Continuing release workflow."
              }
            }
          }
          if (-not $notified) {
            exit 0
          }

      - name: Update GitHub Release Notes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const tag = "v${{ steps.get-version.outputs.version }}";
            const body = fs.readFileSync("release_body.md", "utf8");
            const { owner, repo } = context.repo;
            const release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
            await github.rest.repos.updateRelease({
              owner,
              repo,
              release_id: release.data.id,
              body
            });
